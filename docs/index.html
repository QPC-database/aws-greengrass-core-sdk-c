<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>AWS Greengrass Core SDK for C: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AWS Greengrass Core SDK for C
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">AWS Greengrass Core SDK for C Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Overview</h2>
<p>The AWS Greengrass Core SDK for C provides an interface to interact with the Greengrass Core system on the edge. It is c89 compliant and is meant to be performant while minimizing dependencies.</p>
<p>AWS Greengrass Core SDK for C is now in General Availability.</p>
<h2>Requirements</h2>
<ul>
<li>libc 2.14+</li>
<li>cmake 2.8+</li>
<li>Greengrass Core 1.6+</li>
</ul>
<h2>Building the SDK</h2>
<p>Clone the SDK into local workspace:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;git clone https://github.com/aws/aws-greengrass-core-sdk-c.git</div>
</div><!-- fragment --><p>Build the SDK:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;cd aws-greengrass-core-sdk-c</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;mkdir build &amp;&amp; cd build</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;cmake ..</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;cmake --build .</div>
</div><!-- fragment --><p>The build will produce a shared object named <b>libaws-greengrass-core-sdk-c.so</b> under the build/aws-greengras-core-sdk-c directory. This is the shared object that the Lambda executable links to.</p>
<p><b>Note:</b></p><ul>
<li>The shared object is a stub implementation that helps Lambda executables to link against. It will be overridden by the actual shared object that comes with the Greengrass Core release bundle.</li>
<li>The <code>-Wl,--enable-new-dtags</code> flag is needed for adding the Greengrass C SDK shared object path into the Lambda executable's RUNPATH, so that the stub shared object can be overridden by the <b>libaws-greengrass-core-sdk-c.so</b> which comes along with the Greengrass Core Release bundle. It is automatically included when linking to the aws-greengrass-core-sdk-c.</li>
</ul>
<h2>Building Greengrass Native Lambda Executables with CMake</h2>
<p>You can use CMake to build Greengrass Lambda executables. Other build tools could work as well. Here cmake is shown as an example:</p>
<h3>Setting up a CMake Project</h3>
<p>Create a directory to hold your project:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;mkdir my_gg_native_function</div>
</div><!-- fragment --><p>Open the directory and add a <code>CMakeLists.txt</code> file that specifies your project's name, executables, source files, and linked libraries. The following is a minimal example:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# minimal CMakeLists.txt for the AWS Greengrass SDK for C</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;cmake_minimum_required(VERSION 2.8)</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;# &quot;my_gg_native_function&quot; is just an example value.</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;project(my_gg_native_function)</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;# Locate the AWS Greengras SDK for C package.</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;# Requires that you build with:</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;#   -Daws-greengrass-core-sdk-c_DIR=/path/to/sdk_build</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;# or export/set:</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;#   CMAKE_PREFIX_PATH=/path/to/sdk_build</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;find_package(aws-greengrass-core-sdk-c REQUIRED)</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;add_executable(my_gg_native_funtion main.cpp)</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;target_link_libraries(my_gg_native_funtion aws-greengrass-core-sdk-c)</div>
</div><!-- fragment --><p>To get started quickly, there are several pre-made examples in the aws-greengras-core-sdk-c-example directory for your reference. Those examples are built along with the SDK.</p>
<h2>Creating Deployment Package</h2>
<p>After the Lambda executable is built, it should be packaged into a deployment package, which is a zip file consisting of your executable and any dependencies. Then you can upload the package to AWS Lambda and deploy it to a device by following the normal AWS Greengrass process.</p>
<h2>Using the SDK</h2>
<h3>Initialization</h3>
<p>All code that uses the AWS Greengrass SDK for C must do <b><a class="el" href="greengrasssdk_8h.html#aceaad1db83919d3f6ed34a26bcc34fa8" title="Initialize Greengrass internal global variables. ">gg_global_init()</a></b> before calling any other APIs and <b><a class="el" href="greengrasssdk_8h.html#ab78618faaa5bed2c6674de502117329c" title="Registers the lambda handler and start Greengrass lambda runtime. ">gg_runtime_start()</a></b> to start the runtime, as follows: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;#include &quot;greengrasssdk.h&quot;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;void handler(const gg_lambda_context *cxt) {</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    /* Your lambda logic goes here. */</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;}</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;int main() {</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    gg_global_init(0);</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    /* start the runtime in blocking mode. This blocks forever. */</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;    gg_runtime_start(handler, 0);</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;}</div>
</div><!-- fragment --><h3>Reading Event Payload</h3>
<p>To read the event payload for the Lambda handler to process, use <b><a class="el" href="greengrasssdk_8h.html#a57e43dfa464b5fe29b86f252a0416ecf" title="Read the data from the invoker of the lambda. This method should be called till amount_read is zero...">gg_lambda_handler_read()</a></b>. The amount of data written into the buffer is not guaranteed to be complete until <b>amount_read</b> is zero.</p>
<p>The following is a sample usage of the method:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;/* loop read handler event into buffer. */</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;gg_error loop_lambda_handler_read(void *buffer,</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;        size_t buffer_size, size_t *total_read) {</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    gg_error err = GGE_SUCCESS;</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    uint8_t *read_index = (uint8_t*)buffer;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    size_t remaining_buf_size = buffer_size;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    size_t amount_read = 0;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    do {</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;        err = gg_lambda_handler_read(read_index, remaining_buf_size,</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;                &amp;amount_read);</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;        if(err) {</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;            gg_log(GG_LOG_ERROR, &quot;gg_lambda_handler_read had an error&quot;);</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;            goto cleanup;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;        }</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;        *total_read += amount_read;</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;        read_index += amount_read;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;        remaining_buf_size -= amount_read;</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;    } while(amount_read);</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;cleanup:</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;    return err;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;}</div>
</div><!-- fragment --> <h3>Writing Handler Response</h3>
<p>After the Lambda handler finishes processing, a response can be returned using <b><a class="el" href="greengrasssdk_8h.html#a1644bd17a5b78be79d836cf02af78f30" title="Write response to the invoker of the lambda. ">gg_lambda_handler_write_response()</a></b>. If this method is not called, an empty response will be returned.</p>
<h3>Writing Handler Error Response</h3>
<p>When the Lambda handler encounters any error, the error response can be returned to the caller using <b><a class="el" href="greengrasssdk_8h.html#afbd99e7acd2436ccb87c93a2be1f1de5" title="Write error message to the invoker of the lambda. ">gg_lambda_handler_write_error()</a></b>.</p>
<h3>Initialize API Request</h3>
<p>Every API request must be initialized using <b><a class="el" href="greengrasssdk_8h.html#a092e16cf409e45ff35b8fc48448b8c9e" title="Initialize the context for managing the request. ">gg_request_init()</a></b> before making the actual request.</p>
<h3>Reading API Response</h3>
<p>There are several cases which require reading a response after an API call, such as <b><a class="el" href="greengrasssdk_8h.html#a4b0f92a979b445a7f66659e9c40c9c4a" title="Invoke a lambda with an optional payload. ">gg_invoke()</a></b>, <b><a class="el" href="greengrasssdk_8h.html#a2357ea43740fcce39528ad2e956c02a3" title="Get thing shadow for thing name. ">gg_get_thing_shadow()</a></b>, etc. <b><a class="el" href="greengrasssdk_8h.html#a6b09c46f26477a17fe94c6d8e6e6dd0d" title="Read the data from a request. This method should be called till amount_read is zero. ">gg_request_read()</a></b> should be used after the method call to retrieve the output response.</p>
<p>The following is a sample usage of the method:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;/* loop read request bytes into buffer. */</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;gg_error loop_request_read(gg_request ggreq, void *buffer,</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;        size_t buffer_size, size_t *total_read) {</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    gg_error err = GGE_SUCCESS;</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    uint8_t *read_index = (uint8_t*)buffer;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    size_t remaining_buf_size = buffer_size;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;    size_t amount_read = 0;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    do {</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;        err = gg_request_read(ggreq, read_index, remaining_buf_size,</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;                &amp;amount_read);</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;        if(err) {</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;            gg_log(GG_LOG_ERROR, &quot;gg_lambda_handler_read had an error&quot;);</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;            goto cleanup;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;        }</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;        *total_read += amount_read;</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;        read_index += amount_read;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;        remaining_buf_size -= amount_read;</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;    } while(amount_read);</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;cleanup:</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;    return err;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;}</div>
</div><!-- fragment --><h3>Error Handling</h3>
<p>When there is an error on method call, all the APIs have <b>gg_error</b> returned as the return code. And for <b><a class="el" href="greengrasssdk_8h.html#a89845120797c946632b9f87023fbd2c3" title="Publish a payload to a topic. ">gg_publish_with_options()</a></b>, <b><a class="el" href="greengrasssdk_8h.html#ae232d959a2cf3baea678340e00c07814" title="Publish a payload to a topic. ">gg_publish()</a></b>, <b><a class="el" href="greengrasssdk_8h.html#a4b0f92a979b445a7f66659e9c40c9c4a" title="Invoke a lambda with an optional payload. ">gg_invoke()</a></b> and <b>gg_xxx_thing_shadow()</b> APIs, you can check server side error from request status from the <b><a class="el" href="greengrasssdk_8h.html#a3b21b3e2528b6107f6d938cab569cfe0" title="Describes result metadata after request is made. ">gg_request_result()</a></b> struct.</p>
<h2>Opening Issues</h2>
<p>If you encounter a bug with the AWS Greengrass SDK for C, we would like to hear about it. Search the <a href="https://github.com/aws/aws-greengrass-core-sdk-c/issues">existing issues</a> and see if others are also experiencing the issue before opening a new issue. When creating issue, please fill in the following template: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[Problem Description]:  Describe the problem in detail</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;[Reproduction Steps]: Describe the steps in detail</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;[Target OS/Architecture]: eg. x86_64 Ubuntu 16.04</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;[Greengrass Core Version]: eg. 1.6.0</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;[Greengrass Core SDK for C Version]: eg. 1.0.0</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;[Compiler and Version] : eg. GCC 5.0 / LLVM 7</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;[Cmake Version] eg. Cmake 3.2</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;[Logs] runtime.log, lambda log</div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
